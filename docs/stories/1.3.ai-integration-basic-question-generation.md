# Story 1.3: AI Integration and Basic Question Generation

## Status
Draft

## Story
**As a** teacher,
**I want** the system to generate questions from my curriculum content using AI,
**so that** I can see the core functionality working end-to-end.

## Acceptance Criteria
1. OpenAI API integration is implemented with proper API key management
2. Basic prompt template generates multiple-choice and short-answer questions
3. Generated questions are displayed in a readable format
4. AI responses are parsed and structured for display
5. Error handling manages API failures and rate limiting
6. Generated content is validated for quality and relevance

## Tasks / Subtasks
- [ ] Set up OpenAI API integration (AC: 1)
  - [ ] Install OpenAI SDK and configure API client
  - [ ] Implement secure API key management
  - [ ] Add environment variable configuration
- [ ] Create basic prompt templates (AC: 2)
  - [ ] Design prompt for multiple-choice questions
  - [ ] Design prompt for short-answer questions
  - [ ] Add content-specific prompt variations
- [ ] Implement question generation service (AC: 2, 3)
  - [ ] Create AI service for question generation
  - [ ] Add response parsing and structuring
  - [ ] Implement question display formatting
- [ ] Add AI response parsing and structuring (AC: 4)
  - [ ] Parse JSON responses from OpenAI
  - [ ] Validate response structure
  - [ ] Handle malformed responses gracefully
- [ ] Implement error handling for API failures (AC: 5)
  - [ ] Handle API key validation errors
  - [ ] Manage rate limiting with retry logic
  - [ ] Add timeout handling for long requests
- [ ] Add content validation for quality and relevance (AC: 6)
  - [ ] Validate question content appropriateness
  - [ ] Check for educational relevance
  - [ ] Filter out inappropriate content

## Dev Notes

### Previous Story Insights
[Source: Story 1.2 completion context]
- PDF processing and text extraction is complete
- Document model with extracted_text field is available
- File upload and storage infrastructure is in place
- Processing status UI components are implemented

### Data Models
[Source: architecture.md#data-models]

**QuestionSet Model:**
```typescript
interface QuestionSet {
  id: string;
  document_id: string;
  user_id: string;
  title: string;
  question_count: number;
  generation_status: 'generating' | 'completed' | 'failed';
  created_at: Date;
  exported_at: Date;
}
```

**Question Model:**
```typescript
interface Question {
  id: string;
  question_set_id: string;
  question_type: 'multiple_choice' | 'short_answer' | 'true_false';
  question_text: string;
  correct_answer: string;
  options: string[]; // For multiple choice
  difficulty: 'easy' | 'medium' | 'hard';
  order_index: number;
  created_at: Date;
}
```

### API Specifications
[Source: architecture.md#api-specification]

**Key Endpoints for this story:**
- `POST /api/question-sets` - Generate questions from document
- `GET /api/question-sets` - Get user's question sets
- `GET /api/question-sets/{id}` - Get question set with questions
- `DELETE /api/question-sets/{id}` - Delete question set

**OpenAI API Integration:**
- Endpoint: `POST https://api.openai.com/v1/chat/completions`
- Model: GPT-4
- Authentication: Bearer token (API key)
- Rate Limits: 3,500 requests per minute, 10,000 tokens per minute

### Component Specifications
[Source: architecture.md#components]

**Question Generation Component:**
- Configure and trigger AI question generation with basic settings
- Technology Stack: MUI Form components, TypeScript interfaces
- Must provide user controls for question generation parameters

**AI Question Generation Service:**
- Integrate with OpenAI API to generate questions from extracted text
- Technology Stack: OpenAI SDK, TypeScript, prompt engineering
- Must handle API responses and error cases

### File Locations
[Source: architecture.md#unified-project-structure]

**Backend Service Files:**
```
apps/web/src/api/question-sets/
├── index.ts         # GET, POST /api/question-sets
├── [id].ts         # GET, DELETE /api/question-sets/[id]
└── [id]/export.ts  # POST /api/question-sets/[id]/export
```

**Frontend Component Files:**
```
apps/web/src/components/features/questions/
├── QuestionGenerationForm.tsx
├── QuestionDisplay.tsx
└── QuestionGenerationStatus.tsx
```

**Service Files:**
```
apps/web/src/services/
├── aiService.ts
├── questionGenerationService.ts
└── openaiService.ts
```

### Testing Requirements
[Source: architecture.md#testing-strategy]

**Testing Standards:**
- Test file location: `apps/web/src/__tests__/` for unit tests
- Testing frameworks: Vitest + Testing Library for unit and integration tests
- Unit test coverage: Minimum 80% code coverage for new functionality

**Testing Requirements for this story:**
- Unit tests for AI service integration
- Unit tests for prompt template generation
- Unit tests for response parsing and validation
- Integration tests for question generation workflow
- Mock OpenAI API responses for testing

### Technical Constraints
[Source: architecture.md#tech-stack]

**OpenAI API Configuration:**
- Model: GPT-4 for high-quality question generation
- Temperature: 0.7 for balanced creativity and consistency
- Max tokens: 2000 per request
- Timeout: 30 seconds per request

**Environment Variables:**
```bash
OPENAI_API_KEY=your_openai_api_key
DEFAULT_QUESTION_COUNT=10
MAX_QUESTION_COUNT=50
OPENAI_MODEL=gpt-4
OPENAI_TEMPERATURE=0.7
```

**Security Requirements:**
- API key stored securely in environment variables
- No API key exposure in client-side code
- Rate limiting to prevent abuse
- Input validation for all user inputs

**Performance Requirements:**
- Question generation should complete within 30 seconds
- Handle rate limiting gracefully with retry logic
- Efficient prompt engineering to minimize token usage

### Error Scenarios
[Source: prd-epic1-stories.md#story-13]

**Error Handling Requirements:**
- API Key Invalid: "AI service configuration error. Please contact support"
- API Rate Limit Exceeded: "AI service is busy. Please wait a moment and try again"
- API Timeout: "AI processing is taking longer than expected. Please try again"
- API Service Unavailable: "AI service is temporarily unavailable. Please try again later"
- Invalid AI Response: "Unable to process AI response. Please try generating questions again"
- Insufficient Content: "Content is too short for question generation. Please use a longer document"
- Inappropriate Content: "Content may not be suitable for educational use. Please review and try again"
- Network Connection Lost: "Connection lost during AI processing. Please check your internet and try again"
- Malformed Questions: "Some questions could not be generated properly. Please try again"

## Testing

### Testing Standards
[Source: architecture.md#testing-strategy]

**Test File Location:**
- Unit tests: `apps/web/src/__tests__/`
- Integration tests: `apps/web/src/__tests__/integration/`
- E2E tests: `apps/web/e2e/`

**Testing Frameworks:**
- Unit/Integration: Vitest + Testing Library
- E2E: Playwright (for future stories)

**Test Coverage Requirements:**
- Minimum 80% code coverage for new functionality
- All AI service functions must have unit tests
- All error scenarios must be tested

**Testing Patterns:**
- Mock OpenAI API responses for consistent testing
- Test prompt template generation with various inputs
- Validate response parsing and error handling
- Test question generation with different content types

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| [Current Date] | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_
