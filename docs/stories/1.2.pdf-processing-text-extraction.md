# Story 1.2: PDF Processing and Text Extraction

## Status
Draft

## Story
**As a** teacher,
**I want** to upload a PDF and have the system extract the text content,
**so that** the AI can generate questions based on my curriculum material.

## Acceptance Criteria
1. PDF files are successfully uploaded and stored temporarily
2. Text content is extracted from PDF using a reliable parsing library
3. Extracted text is cleaned and formatted for AI processing
4. Processing status is displayed to the user during text extraction
5. Error handling manages corrupted or unreadable PDF files
6. Extracted text is validated for minimum content length (prevents empty results)

## Tasks / Subtasks
- [ ] Implement PDF upload endpoint (AC: 1)
  - [ ] Create POST /api/documents endpoint
  - [ ] Add file validation and storage logic
  - [ ] Implement temporary file cleanup mechanism
- [ ] Integrate pdf-parse library for text extraction (AC: 2)
  - [ ] Install and configure pdf-parse library
  - [ ] Create text extraction service
  - [ ] Add error handling for parsing failures
- [ ] Add text cleaning and formatting logic (AC: 3)
  - [ ] Remove extra whitespace and formatting artifacts
  - [ ] Normalize text encoding and line breaks
  - [ ] Structure text for optimal AI processing
- [ ] Create processing status UI component (AC: 4)
  - [ ] Design real-time status display
  - [ ] Add progress indicators for text extraction
  - [ ] Implement WebSocket or polling for status updates
- [ ] Implement error handling for PDF processing (AC: 5)
  - [ ] Handle corrupted PDF files
  - [ ] Manage password-protected PDFs
  - [ ] Process image-only PDFs with appropriate messaging
- [ ] Add text validation for minimum content length (AC: 6)
  - [ ] Set minimum text length requirements
  - [ ] Validate extracted text quality
  - [ ] Provide user feedback for insufficient content

## Dev Notes

### Previous Story Insights
[Source: Story 1.1 completion context]
- React application foundation is established with file upload component
- Material UI components are configured and ready
- Basic routing structure is in place
- File validation framework exists for PDF files

### Data Models
[Source: architecture.md#data-models]

**Document Model (Updated):**
```typescript
interface Document {
  id: string;
  user_id: string;
  filename: string;
  file_path: string;
  file_size: number;
  upload_status: 'uploading' | 'processing' | 'completed' | 'failed';
  extracted_text: string;
  created_at: Date;
  processed_at: Date;
}
```

**Processing Status Types:**
```typescript
type UploadStatus = 'uploading' | 'processing' | 'completed' | 'failed';
```

### API Specifications
[Source: architecture.md#api-specification]

**Key Endpoints for this story:**
- `POST /api/documents` - Upload PDF document with multipart form data
- `GET /api/documents/{id}` - Get document details and processing status
- `POST /api/documents/{id}/process` - Start document processing
- `DELETE /api/documents/{id}` - Delete document and cleanup files

**Request/Response Formats:**
```typescript
// POST /api/documents
interface UploadRequest {
  file: File;
  metadata?: {
    title?: string;
    description?: string;
  };
}

// Response
interface DocumentResponse {
  id: string;
  filename: string;
  file_size: number;
  upload_status: UploadStatus;
  created_at: string;
  processed_at?: string;
}
```

### Component Specifications
[Source: architecture.md#components]

**Document Processing Status Component:**
- Display real-time processing status and extracted text preview
- Technology Stack: MUI Progress components, Zustand state management
- Must show processing progress and handle error states

**File Processing Service:**
- Handle PDF upload, text extraction, and file storage management
- Technology Stack: Node.js, pdf-parse, Vercel Blob SDK
- Must integrate with Vercel Blob Storage for temporary file storage

### File Locations
[Source: architecture.md#unified-project-structure]

**Backend Service Files:**
```
apps/web/src/api/documents/
├── index.ts          # GET, POST /api/documents
├── [id].ts          # GET, DELETE /api/documents/[id]
└── [id]/process.ts  # POST /api/documents/[id]/process
```

**Frontend Component Files:**
```
apps/web/src/components/features/processing/
├── DocumentProcessingStatus.tsx
├── TextExtractionProgress.tsx
└── ExtractedTextPreview.tsx
```

**Service Files:**
```
apps/web/src/services/
├── documentService.ts
├── pdfProcessingService.ts
└── fileStorageService.ts
```

### Testing Requirements
[Source: architecture.md#testing-strategy]

**Testing Standards:**
- Test file location: `apps/web/src/__tests__/` for unit tests
- Testing frameworks: Vitest + Testing Library for unit and integration tests
- Unit test coverage: Minimum 80% code coverage for new functionality

**Testing Requirements for this story:**
- Unit tests for PDF processing service
- Unit tests for text extraction logic
- Unit tests for processing status component
- Integration tests for file upload and processing workflow
- Error scenario testing for all defined error cases

### Technical Constraints
[Source: architecture.md#tech-stack]

**PDF Processing Library:**
- pdf-parse: Reliable PDF text extraction
- File size limits: 10MB maximum
- Supported formats: PDF only

**Storage Requirements:**
- Vercel Blob Storage for temporary file storage
- Automatic cleanup after processing
- Secure file access with signed URLs

**Environment Variables:**
```bash
MAX_FILE_SIZE=10485760  # 10MB
ALLOWED_FILE_TYPES=application/pdf
VERCEL_BLOB_READ_WRITE_TOKEN=your_blob_token
```

**Performance Requirements:**
- Text extraction should complete within 30 seconds
- File upload should handle files up to 10MB
- Processing status updates should be real-time

### Error Scenarios
[Source: prd-epic1-stories.md#story-12]

**Error Handling Requirements:**
- Corrupted PDF: "PDF file appears to be corrupted. Please try a different file"
- Password-Protected PDF: "This PDF is password-protected. Please provide an unprotected version"
- Image-Only PDF: "PDF contains only images. Please use a text-based PDF for better results"
- Empty PDF: "PDF appears to be empty or contains no readable text"
- Processing Timeout: "PDF processing is taking longer than expected. Please wait or try a smaller file"
- Storage Failure: "Unable to store file temporarily. Please try again"
- Text Extraction Failure: "Unable to extract text from PDF. Please ensure the file is not corrupted"
- Insufficient Text: "Extracted text is too short for question generation. Please use a longer document"

## Testing

### Testing Standards
[Source: architecture.md#testing-strategy]

**Test File Location:**
- Unit tests: `apps/web/src/__tests__/`
- Integration tests: `apps/web/src/__tests__/integration/`
- E2E tests: `apps/web/e2e/`

**Testing Frameworks:**
- Unit/Integration: Vitest + Testing Library
- E2E: Playwright (for future stories)

**Test Coverage Requirements:**
- Minimum 80% code coverage for new functionality
- All PDF processing functions must have unit tests
- All error scenarios must be tested

**Testing Patterns:**
- Mock PDF files for testing text extraction
- Test file upload with various file types and sizes
- Validate error handling for all defined scenarios
- Test processing status updates and UI components

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| [Current Date] | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_
