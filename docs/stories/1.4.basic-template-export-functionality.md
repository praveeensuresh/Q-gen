# Story 1.4: Basic Template and Export Functionality

## Status
Draft

## Story
**As a** teacher,
**I want** to export generated questions in a basic format,
**so that** I can use the questions in my teaching immediately.

## Acceptance Criteria
1. Basic template structure formats questions consistently
2. Questions are numbered and organized by type (MCQ, Short Answer)
3. Export functionality generates a downloadable file (PDF or DOCX)
4. Template includes basic formatting (headers, question numbering)
5. Export process handles errors gracefully
6. Generated file is properly formatted and readable

## Tasks / Subtasks
- [ ] Create basic template structure (AC: 1)
  - [ ] Design template layout for questions
  - [ ] Implement consistent formatting rules
  - [ ] Add template validation logic
- [ ] Implement question numbering and organization (AC: 2)
  - [ ] Add automatic question numbering
  - [ ] Organize questions by type (MCQ, Short Answer)
  - [ ] Create question type headers
- [ ] Add PDF export functionality (AC: 3)
  - [ ] Integrate PDF generation library (jsPDF)
  - [ ] Create PDF template with proper formatting
  - [ ] Implement file download mechanism
- [ ] Add DOCX export functionality (AC: 3)
  - [ ] Integrate DOCX generation library (docx)
  - [ ] Create Word document template
  - [ ] Ensure consistent formatting across formats
- [ ] Implement basic formatting (headers, numbering) (AC: 4)
  - [ ] Add document headers and footers
  - [ ] Implement consistent question numbering
  - [ ] Add proper spacing and typography
- [ ] Add export error handling (AC: 5)
  - [ ] Handle file generation errors
  - [ ] Manage download failures
  - [ ] Provide user feedback for errors
- [ ] Create download interface (AC: 6)
  - [ ] Design export options UI
  - [ ] Add download progress indicators
  - [ ] Implement file naming conventions

## Dev Notes

### Previous Story Insights
[Source: Story 1.3 completion context]
- AI question generation is complete with QuestionSet and Question models
- OpenAI API integration is working
- Question display components are implemented
- Basic question types (MCQ, short answer) are supported

### Data Models
[Source: architecture.md#data-models]

**Export Metadata:**
```typescript
interface ExportMetadata {
  question_set_id: string;
  document_title: string;
  generated_date: string;
  question_count: number;
  institution_name?: string;
  teacher_name?: string;
}
```

**Template Configuration:**
```typescript
interface TemplateConfig {
  format: 'pdf' | 'docx';
  include_headers: boolean;
  include_footers: boolean;
  question_numbering: boolean;
  institution_name?: string;
  custom_header?: string;
}
```

### API Specifications
[Source: architecture.md#api-specification]

**Key Endpoints for this story:**
- `POST /api/question-sets/{id}/export` - Export question set
- `GET /api/question-sets/{id}` - Get question set with questions for export

**Export Request Format:**
```typescript
interface ExportRequest {
  format: 'pdf' | 'docx';
  template_config?: TemplateConfig;
  metadata?: ExportMetadata;
}
```

### Component Specifications
[Source: architecture.md#components]

**Question Preview Component:**
- Display generated questions with basic editing and export options
- Technology Stack: MUI DataGrid, Rich text editor
- Must show questions in export-ready format

**Template Engine Service:**
- Process predefined templates with placeholders and generate formatted output
- Technology Stack: Markdown-it, docx library, PDF generation
- Must support both PDF and DOCX formats

**Export Service:**
- Generate downloadable files in various formats with proper formatting
- Technology Stack: jsPDF, docx library, Vercel Blob Storage
- Must handle file generation and download

### File Locations
[Source: architecture.md#unified-project-structure]

**Backend Service Files:**
```
apps/web/src/api/question-sets/
└── [id]/export.ts  # POST /api/question-sets/[id]/export
```

**Frontend Component Files:**
```
apps/web/src/components/features/export/
├── ExportOptions.tsx
├── TemplatePreview.tsx
└── DownloadProgress.tsx
```

**Service Files:**
```
apps/web/src/services/
├── templateService.ts
├── exportService.ts
└── fileGenerationService.ts
```

**Template Files:**
```
apps/web/src/templates/
├── basic-pdf-template.html
├── basic-docx-template.html
└── template-configs/
    ├── default.json
    └── custom.json
```

### Testing Requirements
[Source: architecture.md#testing-strategy]

**Testing Standards:**
- Test file location: `apps/web/src/__tests__/` for unit tests
- Testing frameworks: Vitest + Testing Library for unit and integration tests
- Unit test coverage: Minimum 80% code coverage for new functionality

**Testing Requirements for this story:**
- Unit tests for template generation
- Unit tests for export functionality
- Unit tests for file formatting
- Integration tests for complete export workflow
- Test both PDF and DOCX export formats

### Technical Constraints
[Source: architecture.md#tech-stack]

**Export Libraries:**
- jsPDF: PDF generation with formatting
- docx: Word document generation
- File size limits: 50MB maximum for exports
- Supported formats: PDF, DOCX

**Environment Variables:**
```bash
MAX_EXPORT_SIZE=52428800  # 50MB
SUPPORTED_EXPORT_FORMATS=pdf,docx
DEFAULT_TEMPLATE=basic
```

**Performance Requirements:**
- Export generation should complete within 60 seconds
- Support up to 100 questions per export
- Efficient memory usage for large question sets

**File Storage:**
- Vercel Blob Storage for temporary export files
- Automatic cleanup after 24 hours
- Secure download URLs with expiration

### Error Scenarios
[Source: prd-epic1-stories.md#story-14]

**Error Handling Requirements:**
- No Questions to Export: "No questions available for export. Please generate questions first"
- Export Generation Failure: "Unable to create export file. Please try again"
- File Download Failure: "Download failed. Please check your browser settings and try again"
- Template Processing Error: "Template formatting error. Please try again or contact support"
- Insufficient Storage: "Not enough storage space for export. Please free up space and try again"
- Format Not Supported: "Selected format is not available. Please choose PDF or DOCX"
- Large File Export: "Export file is large. This may take a moment. Please wait..."
- Corrupted Export: "Export file appears corrupted. Please try generating again"
- Browser Download Blocked: "Browser blocked download. Please allow downloads and try again"

## Testing

### Testing Standards
[Source: architecture.md#testing-strategy]

**Test File Location:**
- Unit tests: `apps/web/src/__tests__/`
- Integration tests: `apps/web/src/__tests__/integration/`
- E2E tests: `apps/web/e2e/`

**Testing Frameworks:**
- Unit/Integration: Vitest + Testing Library
- E2E: Playwright (for future stories)

**Test Coverage Requirements:**
- Minimum 80% code coverage for new functionality
- All export functions must have unit tests
- All error scenarios must be tested

**Testing Patterns:**
- Test template generation with various question sets
- Validate export file formats and content
- Test error handling for all defined scenarios
- Mock file generation and download processes

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| [Current Date] | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes List
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_
